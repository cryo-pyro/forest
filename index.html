<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ukubona â€” Tree â‡„ Forest (Per-Tree Lenses)</title>
<style>
  :root{
    --bg:#0b0d0f; --soil:#2c2b28; --root:#7b4b2a; --trunk:#6b523f;
    --branch:#2f5f3b; --canopy:#51a06a; --haze:#7fcaa0; --fruit:#e55b58;
    --seed:#f1c84e; --life:#5dd69b; --recur:#e56a6a; --text:#e7efe9; --dim:#a9b6ae;
    --focus:#9fe8c6; --panel:#0b0d0f; --stroke:#1f2326; --accent:#8ee8ff; --gauge:#8ee8ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    color:var(--text); background: radial-gradient(1200px 900px at 50% 0%, #0e1113, var(--bg));
  }
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  .card{background:#0a0c0e; border:1px solid var(--stroke); border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.35); overflow:hidden}
  header{padding:20px 20px 0 20px}
  h1{font-size:22px; margin:0 0 4px}
  .sub{color:var(--dim); font-size:14px; margin:0 0 12px}
  .controls{display:flex; gap:10px; flex-wrap:wrap; padding:0 20px 10px}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px; border:1px solid #2a2f33; background:#0e1114; color:#cfd8d2; font-size:12px}
  button.chip{cursor:pointer}
  svg{display:block; width:100%; height:72vh; background:linear-gradient(#0a0c0e,#0d1012)}
  .legend{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:10px; padding:10px 20px 20px}
  .legend .sw{display:inline-block;width:24px;height:3px;border-radius:2px;margin-right:8px;vertical-align:middle}
  .sheet{position: fixed; top:0; right:-460px; width:440px; max-width:92vw; height:100%; background:var(--panel); border-left:1px solid var(--stroke); box-shadow:-20px 0 60px rgba(0,0,0,.4); transition:right .35s ease; padding:22px; z-index:30; overflow:auto;}
  .sheet.open{ right:0; }
  .sheet h2{margin:0 0 6px; font-size:20px}
  .sheet .subline{color:var(--dim); margin:0 0 14px; font-size:13px}
  .sheet .body{line-height:1.6; font-size:14px; color:#ced7d1}
  .close{position:absolute; top:10px; right:14px; background:none; border:1px solid #2a2f33; color:#cfd8d2; border-radius:10px; padding:6px 10px; cursor:pointer}
  .halo{pointer-events:none}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; padding:.1em .35em; border:1px solid #2a2f33; border-radius:6px; background:#0f1316}
  .hint{color:#a9b6ae; font-size:12px}
  .foot-chorus{max-width:1200px;margin:14px auto 40px; padding:8px 16px; font-size:12px; color:#bcd6cd; opacity:.9}
  .foot-chorus p{margin:6px 0}
  #err{display:none; white-space:pre-wrap; background:#160b0b; color:#ffdede; padding:8px 12px; border-top:1px solid #3b1f1f}
  .showerr #err{display:block}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>Ukubona â€” Tree â‡„ Forest (Per-Tree Lenses)</h1>
        <p class="sub" id="subtitle">
          Global Mode: <strong>Life Stages</strong>. Toggle <span class="kbd">F</span> for Forest.
          Toggle <span class="kbd">G</span> for <strong>Per-Tree</strong> lenses. Press <span class="kbd">M</span> to cycle global mode.
        </p>
      </header>

      <div class="controls">
        <button class="chip" id="mode">â‡„ Global Mode</button>
        <button class="chip" id="toggleForest">ðŸŒ² Forest: Off</button>
        <button class="chip" id="togglePerTree">ðŸ§© Per-Tree Lenses: Off</button>
        <button class="chip" id="randomize">â†» Randomize</button>
        <span class="chip"><span class="sw" style="background:var(--gauge)"></span>Dynamometer</span>
        <span class="chip"><span class="sw" style="background:var(--accent)"></span>SchrÃ¶dinger</span>
      </div>

      <svg id="scene" viewBox="0 0 1200 1200" role="img" aria-label="Ukubona Tree/Forest">
        <rect x="0" y="1150" width="1200" height="16" fill="var(--soil)" opacity=".18"/>
        <rect x="0" y="1132" width="1200" height="16" fill="var(--soil)" opacity=".14"/>
        <rect x="0" y="1114" width="1200" height="16" fill="var(--soil)" opacity=".10"/>
        <g id="grove"></g>
      </svg>

      <div class="legend" id="legend"></div>
      <pre id="err"></pre>
    </div>
    <p class="hint">Keys â€” <span class="kbd">M</span> global mode, <span class="kbd">F</span> forest on/off, <span class="kbd">G</span> per-tree lenses, <span class="kbd">R</span> randomize, <span class="kbd">Esc</span> close sheet.</p>
  </div>

  <aside id="sheet" class="sheet" aria-hidden="true">
    <button class="close" id="closeSheet">Close</button>
    <h2 id="sTitle">Layer</h2>
    <p id="sSub" class="subline"></p>
    <div id="sBody" class="body"></div>
    <p id="sMeta" class="subline" style="margin-top:16px; font-style:italic"></p>
  </aside>

  <div class="foot-chorus">
    <p><em>This is play, not prescription. This is rehearsal, not remedy. This is simulation, not salvation.</em></p>
  </div>

<script>
(function(){
  // ---- debug hook ----
  window.addEventListener('error', (e)=>{
    const pre = document.getElementById('err');
    pre.textContent = (pre.textContent? pre.textContent+"\n":"") + (e.message || e.error);
    document.body.classList.add('showerr');
  });

  // ---------- helpers ----------
  const svgNS = "http://www.w3.org/2000/svg";
  function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function cbez(p0,p1,p2,p3){ return `M ${p0[0]},${p0[1]} C ${p1[0]},${p1[1]} ${p2[0]},${p2[1]} ${p3[0]},${p3[1]}`; }
  function rng(seed){ seed = (seed*16807)%2147483647; return () => (seed = (seed*16807)%2147483647)/2147483647; }
  function path(g,d,attrs){ const el=document.createElementNS(svgNS,"path"); el.setAttribute("d",d); el.setAttribute("fill","none"); for(const k in attrs){ el.setAttribute(k,attrs[k]); } g.appendChild(el); return el; }
  function circle(g,cx,cy,r,attrs){ const el=document.createElementNS(svgNS,"circle"); el.setAttribute("cx",cx); el.setAttribute("cy",cy); el.setAttribute("r",r); for(const k in attrs){ el.setAttribute(k,attrs[k]); } g.appendChild(el); return el; }
  function text(g,x,y,str,attrs){ const el=document.createElementNS(svgNS,"text"); el.setAttribute("x",x); el.setAttribute("y",y); el.setAttribute("text-anchor", attrs.anchor||"start"); delete attrs.anchor; for(const k in attrs){ el.setAttribute(k,attrs[k]); } el.textContent=str; g.appendChild(el); return el; }

  // ---------- datasets (colors resolved at draw time) ----------
  const LIFE = [
    { key:"roots", title:"Roots / Ukuvula", subtitle:"Diet â€” Foundation", meta:"Provisioning â€” energy & matter", y:1120, colorKey:"--root", body:"Infancy & early intake." },
    { key:"trunk", title:"Trunk / Ukuzula", subtitle:"Fitness â€” Structure", meta:"Embodiment â€” capacity", y:930, colorKey:"--trunk", body:"Strength, stability, motor intelligence." },
    { key:"branch", title:"Branching / Ukukona", subtitle:"Games â€” Exploration", meta:"Agency & strategy", y:760, colorKey:"--branch", body:"Divergence, experimentation." },
    { key:"canopy", title:"Canopy / Ukubona", subtitle:"Health â€” Integration", meta:"Context & horizon", y:570, colorKey:"--canopy", body:"Coherent worldview for decisions." },
    { key:"fruit", title:"Fruit / Ukukula", subtitle:"Aging â€” Legacy", meta:"Recursion â€” harvestâ†’seeds", y:380, colorKey:"--fruit", body:"Mentoring & knowledge transfer." },
  ];
  const REALMS = [
    { key:"roots", title:"Physics (Roots)", subtitle:"Ontology â€” constraints", meta:"Conservation & symmetry", y:1120, colorKey:"--root", body:"Substrate of reality." },
    { key:"trunk", title:"Biology (Trunk)", subtitle:"Epistemology â€” bounded mind", meta:"Embodied sensing", y:930, colorKey:"--trunk", body:"Filtering under constraints." },
    { key:"branch", title:"Social (Branching)", subtitle:"Agency â€” feedback", meta:"Trust, signaling", y:760, colorKey:"--branch", body:"Norms & institutions." },
    { key:"canopy", title:"Mathematical (Canopy)", subtitle:"Simulation â€” time compression", meta:"Abstraction & optimization", y:570, colorKey:"--canopy", body:"Rehearsal before action." },
    { key:"fruit", title:"Computational (Fruit)", subtitle:"Strategic recursion", meta:"Fruitâ†’seed logic in code", y:380, colorKey:"--fruit", body:"Self-improvement architectures." },
  ];
  const PLANT_AI = [
    { key:"roots", title:"Plant", subtitle:"Biology-as-physics", meta:"Phototrophy", y:1120, colorKey:"--root", body:"Energy capture & growth." },
    { key:"trunk", title:"Animal", subtitle:"Biology", meta:"Locomotion", y:930, colorKey:"--trunk", body:"Adaptive behavior." },
    { key:"branch", title:"Man", subtitle:"Social", meta:"Language & tools", y:760, colorKey:"--branch", body:"Cooperation & culture." },
    { key:"canopy", title:"Equations", subtitle:"Mathematical", meta:"Abstraction", y:570, colorKey:"--canopy", body:"Predictive models." },
    { key:"fruit", title:"AI", subtitle:"Computational", meta:"Recursion", y:380, colorKey:"--fruit", body:"Novel ontologies." },
  ];
  const PENTAD = [
    { key:"roots", title:"Ukuvula â€” Provisioning", subtitle:"Roots (0â†’)", meta:"Foundation", y:1120, colorKey:"--root", body:"Nutrition, housing, environment." },
    { key:"trunk", title:"Ukuzula â€” Mobility", subtitle:"Trunk (movement)", meta:"Wearables", y:930, colorKey:"--trunk", body:"Speed, cadence, vitality." },
    { key:"branch", title:"Ukukona â€” Games", subtitle:"Branching (experiments)", meta:"Habit loops", y:760, colorKey:"--branch", body:"Behavior shaping." },
    { key:"canopy", title:"Ukubona â€” Health Integration", subtitle:"Canopy (nervous system)", meta:"Orchestration", y:570, colorKey:"--canopy", body:"System regulation across care." },
    { key:"fruit", title:"Ukukula â€” Aging", subtitle:"Fruit (recursion)", meta:"Frailty", y:380, colorKey:"--fruit", body:"ADLs & dignity thresholds." },
  ];
  const GAMES = [
    { key:"roots", title:"God", subtitle:"Ground of value", meta:"Constraint substrate", y:1120, colorKey:"--root", body:"Thermo, time, scarcity." },
    { key:"trunk", title:"Animal", subtitle:"Embodiment", meta:"Perception-action", y:930, colorKey:"--trunk", body:"Drives & fitness." },
    { key:"branch", title:"Man", subtitle:"Agency", meta:"Language & norms", y:760, colorKey:"--branch", body:"Will meets infra." },
    { key:"canopy", title:"Enterprise", subtitle:"Organization", meta:"Firms & platforms", y:570, colorKey:"--canopy", body:"Capital braided with code." },
    { key:"fruit", title:"System", subtitle:"Orchestration", meta:"Resilience & feedback", y:380, colorKey:"--fruit", body:"Ecologies write successors." },
  ];
  const DYNAMO = [
    { key:"roots", title:"Zeroth Principle", subtitle:"Absolute zero unattainable", meta:"Flow down gradients", y:1120, colorKey:"--root", gauge:0.15, body:"Vitality = distance from zero." },
    { key:"trunk", title:"Gradients in Biology", subtitle:"Frailty â†” Vitality", meta:"Fried â†” wearables", y:930, colorKey:"--trunk", gauge:0.25, body:"Movement & recovery." },
    { key:"branch", title:"Collisions", subtitle:"Venture / research / talent", meta:"Creative destruction", y:760, colorKey:"--branch", gauge:0.45, body:"Fertility vs bloat." },
    { key:"canopy", title:"Emergence", subtitle:"Order that amplifies power", meta:"Ecosystems", y:570, colorKey:"--canopy", gauge:0.85, body:"Coherent platform effects." },
    { key:"fruit", title:"Recursion", subtitle:"GPUs â†’ AI â†’ GPUs", meta:"Feedback loop", y:380, colorKey:"--fruit", gauge:1.00, body:"Self-acceleration of compute." },
  ];
  const SCHRO = [
    { key:"roots", title:"DNA (Unattainable)", subtitle:"Code-as-potential", meta:"Ideal vs flux", y:1120, colorKey:"--root", body:"Never frozen; mutations." },
    { key:"trunk", title:"ATP (Gradients)", subtitle:"Energy differences drive life", meta:"Proton pumps", y:930, colorKey:"--trunk", body:"No flow, no life." },
    { key:"branch", title:"Silicon Valley", subtitle:"Collisions", meta:"Creative destruction", y:760, colorKey:"--branch", body:"Dynamism beats stagnation." },
    { key:"canopy", title:"Microsoft", subtitle:"Emergence", meta:"Standards & cloud", y:570, colorKey:"--canopy", body:"Platforms from collisions." },
    { key:"fruit", title:"NVIDIA", subtitle:"Recursion", meta:"Compute demand flywheel", y:380, colorKey:"--fruit", body:"Off-scale vitality." },
  ];

  // lens registry
  const LENSES = [LIFE, REALMS, PLANT_AI, PENTAD, GAMES, DYNAMO, SCHRO];
  const MODE_NAMES = ["Life Stages","Emergent Realms","Plant â†’ AI","Pentad Companies","GAMES Pentad","Dynamometer (2025)","SchrÃ¶dinger Pentad"];

  // ---------- forest with per-tree modes ----------
  // mode: 0..6 (index into LENSES)
  // entity: "firm" | "government" | "household" | "person" | "other"
  const FOREST = [
    { name:"Athens", entity:"government", mode:4,   stump:"Rocky Attica; maritime lanes", specialization:"Olives & wine â†” grain imports", notes:["Amphora logistics","Coinage & democracy","Philosophy export"] },
    { name:"Song China", entity:"government", mode:2, stump:"River valleys; coal/iron", specialization:"Silk/porcelain/iron; paper money", notes:["Compass & maritime trade","Urban guilds","Gunpowder diffusion"] },
    { name:"Venice", entity:"government", mode:4,    stump:"Lagoon choke points", specialization:"Glass â€¢ shipping â€¢ finance", notes:["Double-entry","Insurance & merchant law","Republic institutions"] },
    { name:"Microsoft", entity:"firm", mode:5,       stump:"Dev ecosystems; enterprise", specialization:"Cloud + AI platforms", notes:["Standards & tooling","Capital-scale infra","Ecosystem gravity"] },
    { name:"NVIDIA", entity:"firm", mode:6,          stump:"GPU arch + fabs network", specialization:"Computeâ†’AIâ†’more compute", notes:["CUDA lock-in","HWâ€“SW co-design","Model demand flywheel"] },
    { name:"Household X", entity:"household", mode:0,stump:"Local jobs â€¢ schools â€¢ health", specialization:"Budget â€¢ habits â€¢ care", notes:["Food & housing flows","Movement & sleep loops","Legacy planning"] },
    { name:"Pyromancer", entity:"person", mode:3,    stump:"Constraints â€¢ talents â€¢ aims", specialization:"Ukubona stack â€” nervous system", notes:["Wearablesâ†’risk engines","Game loops for habits","Frailty pipeline"] },
  ];

  // ---------- engine ----------
  const scene = document.getElementById("scene");
  const grove = document.getElementById("grove");
  const subtitle = document.getElementById("subtitle");
  const sheet = document.getElementById("sheet");
  const sTitle = document.getElementById("sTitle");
  const sSub   = document.getElementById("sSub");
  const sBody  = document.getElementById("sBody");
  const sMeta  = document.getElementById("sMeta");
  document.getElementById("closeSheet").onclick = () => sheet.classList.remove("open");

  let GLOBAL_MODE = 0;        // global lens index
  let FOREST_ON = true;       // show many trees by default (you can change)
  let PER_TREE = true;        // per-tree lenses default on (change if you want)

  function addMarkers(defs){
    const m1 = document.createElementNS(svgNS,'marker');
    m1.setAttribute('id','arrowTip'); m1.setAttribute('markerWidth','10'); m1.setAttribute('markerHeight','10');
    m1.setAttribute('refX','5'); m1.setAttribute('refY','5'); m1.setAttribute('orient','auto-start-reverse');
    const p1 = document.createElementNS(svgNS,'path');
    p1.setAttribute('d','M 0 0 L 10 5 L 0 10 z'); p1.setAttribute('fill', getVar('--life'));
    m1.appendChild(p1); defs.appendChild(m1);

    const m2 = document.createElementNS(svgNS,'marker');
    m2.setAttribute('id','arrowThin'); m2.setAttribute('markerWidth','8'); m2.setAttribute('markerHeight','8');
    m2.setAttribute('refX','4'); m2.setAttribute('refY','4'); m2.setAttribute('orient','auto-start-reverse');
    const p2 = document.createElementNS(svgNS,'path');
    p2.setAttribute('d','M 0 0 L 8 4 L 0 8 z'); p2.setAttribute('fill', getVar('--recur'));
    m2.appendChild(p2); defs.appendChild(m2);
  }

  function draw(seed=42){
    grove.innerHTML = "";
    const rand = rng(seed);

    const defs = document.createElementNS(svgNS,'defs');
    addMarkers(defs);
    grove.appendChild(defs);

    // background arcs
    const bg = document.createElementNS(svgNS,'g');
    path(bg, `M 1080,1120 C 1160,780 1160,420 1080,200`, {stroke:getVar("--life"), "stroke-width":6, "marker-end":"url(#arrowTip)", opacity:.95});
    text(bg, 1128, 600, "Younger â†’ Older", {fill:"#9fe8c6", "font-size":20, anchor:"middle", transform:"rotate(-90 1128 600)"});
    path(bg, `M 120,200 C 40,420 40,780 120,1120`, {stroke:getVar("--recur"), "stroke-width":3, "stroke-dasharray":"10 10", "marker-end":"url(#arrowThin)", opacity:.9});
    text(bg, 70, 600, "Recursion â†’ next cycle", {fill:"#f3a2a2", "font-size":14, anchor:"middle", transform:"rotate(90 70 600)"});
    grove.appendChild(bg);

    if(!FOREST_ON){
      const dataset = LENSES[GLOBAL_MODE];
      drawTree(600, rand, dataset, {name:"Single", entity:"other", stump:"â€”", specialization:"â€”", notes:[]}, GLOBAL_MODE, seed);
      badges(false);
    } else {
      const N = FOREST.length;
      const margin = 90, W = 1200;
      const span = (W - 2*margin);
      const step = (N>1) ? span / (N - 1) : 0;
      for(let i=0;i<N;i++){
        const cx = (N>1) ? (margin + i*step) : (W/2);
        const ent = FOREST[i];
        const mode = PER_TREE ? ent.mode : GLOBAL_MODE;
        const dataset = LENSES[mode];
        drawTree(cx, rng(seed + i*9973), dataset, ent, mode, seed+i);
      }
      badges(true);
    }
  }

  function drawTree(cx, rand, dataset, info, modeIndex, seedTag){
    const g = document.createElementNS(svgNS,'g');
    grove.appendChild(g);

    // trunk
    for(let j=0;j<5;j++){
      const jitter = (rand()-0.5)*10;
      const p0=[cx+jitter,1120-8];
      const p3=[cx+jitter,550];
      const p1=[cx-90+(rand()-0.5)*18,950];
      const p2=[cx+90+(rand()-0.5)*18,720];
      path(g, cbez(p0,p1,p2,p3), {stroke:getVar("--trunk"), "stroke-width":18-j*2.5, opacity:.55+j*.08});
    }

    // roots
    for(let k=0;k<7;k++){
      const amp=220+k*26, base=1120-10;
      const p0=[cx,base];
      const p3L=[cx-(380-k*56), base+85+k*10];
      const p1L=[cx-(110+k*18), base+10+k*2];
      const p2L=[cx-amp, base+60+k*6];
      const p3R=[cx+(380-k*56), base+85+k*10];
      const p1R=[cx+(110+k*18), base+10+k*2];
      const p2R=[cx+amp, base+60+k*6];
      path(g, cbez(p0,p1L,p2L,p3L), {stroke:getVar("--root"), "stroke-width":6, opacity:.66});
      path(g, cbez(p0,p1R,p2R,p3R), {stroke:getVar("--root"), "stroke-width":6, opacity:.66});
    }

    // branches + haze
    const levels=[800,720,650];
    levels.forEach((ly,i)=>{
      [-1,1].forEach(dir=>{
        const span=300-i*64;
        const p0=[cx,ly];
        const p3=[cx+dir*(span + (rand()*36)), ly-(40+i*24)];
        const p1=[cx+dir*(110+rand()*36), ly-10];
        const p2=[cx+dir*(220+rand()*36), ly-(25+i*20)];
        path(g, cbez(p0,p1,p2,p3), {stroke:getVar("--branch"), "stroke-width":10-i*2.5, opacity:.9});
        for(let rr=0;rr<2;rr++){
          const ox0=cx+dir*(170+rr*38+rand()*20);
          const oy0=ly-(10+rr*10);
          const ox3=cx+dir*(span*.78+rand()*28);
          const oy3=ly-(0+rr*18);
          const ox1=ox0+dir*(40+rand()*10);
          const oy1=oy0+8;
          const ox2=ox3-dir*(40+rand()*10);
          const oy2=oy3-6;
          path(g, cbez([ox0,oy0],[ox1,oy1],[ox2,oy2],[ox3,oy3]), {stroke:getVar("--branch"), "stroke-width":5-rr, opacity:.55});
          circle(g, ox3, oy3, 12+rand()*10, {fill:getVar("--haze"), opacity:.06+rand()*.05});
        }
      });
    });

    // fruits
    for(let i=0;i<6;i++){
      const x=cx-140 + i*(280/5);
      const y=320 + Math.sin(i*.8 + (seedTag||0)*.001)*10;
      circle(g, x, y, 13,{fill:getVar("--fruit")});
      circle(g, x, y+24, 9,{fill:getVar("--seed"), opacity:.9});
    }

    // rings + labels
    dataset.forEach((layer)=>{
      const color = (modeIndex===3 || modeIndex===4) ? getVar("--accent") : getVar(layer.colorKey);
      const width = (modeIndex===5) ? (10 + (layer.gauge||0)*12) : 10;

      circle(g, cx, layer.y, 52,{fill:"#ffffff", opacity:.02, class:"halo"});
      circle(g, cx, layer.y, 36,{fill:"none", stroke:(modeIndex===5? getVar("--gauge") : color), "stroke-width":width, opacity:.92});
      text(g, cx, layer.y-72, layer.title, {fill:getVar("--text"), "font-size":20, anchor:"middle"});
      text(g, cx, layer.y-50, layer.subtitle, {fill:getVar("--dim"), "font-size":12, anchor:"middle"});

      const hit=circle(g, cx, layer.y, 60,{fill:"#000", opacity:0, cursor:"pointer"});
      hit.addEventListener("click", ()=> openSheet(layer, info, modeIndex));
    });

    // stump caption
    if(info){
      const cap = document.createElementNS(svgNS,'g');
      text(cap, cx, 1180, `${info.name} â€” ${info.entity}`, {fill:"#bcd6cd", "font-size":12, anchor:"middle"});
      text(cap, cx, 1196, `${info.specialization}`, {fill:"#8aa7a0", "font-size":11, anchor:"middle"});
      grove.appendChild(cap);
    }
  }

  function badges(isForest){
    const g = document.createElementNS(svgNS,'g');
    g.setAttribute('transform','translate(24,36)');
    const lines = [];
    lines.push(PER_TREE ? "Per-Tree Lenses: ON" : "Global Lens: ON");
    if(isForest) lines.push("Forest = specialization stumps; roots = locality; branches = trade routes");
    const bg = document.createElementNS(svgNS,'rect');
    bg.setAttribute('x',0); bg.setAttribute('y',0); bg.setAttribute('rx',10);
    bg.setAttribute('width',420); bg.setAttribute('height', lines.length*22+18);
    bg.setAttribute('fill','#0b0f11'); bg.setAttribute('opacity','0.85'); bg.setAttribute('stroke', getVar('--stroke'));
    g.appendChild(bg);
    lines.forEach((t,i)=>{ const tx=document.createElementNS(svgNS,'text'); tx.setAttribute('x',12); tx.setAttribute('y',22+i*22); tx.setAttribute('fill','#bcd6cd'); tx.setAttribute('font-size','12'); tx.textContent='â€¢ '+t; g.appendChild(tx); });
    scene.appendChild(g);
  }

  function openSheet(layer, info, modeIndex){
    const lens = MODE_NAMES[modeIndex] || "Lens";
    sTitle.innerHTML = (info ? `${layer.title} â€” <span class="badge">${info.name}</span>` : layer.title);
    sSub.textContent = `${layer.subtitle}  |  Lens: ${lens}`;
    sBody.textContent  = layer.body;
    const stump = info ? ` â€” <span class="badge">Stump</span> ${info.stump}` : "";
    const extra = info ? ` â€” Specialty: ${info.specialization}` : "";
    const bullets = (info && info.notes && info.notes.length) ? `\nâ€¢ ${info.notes.join("\nâ€¢ ")}` : "";
    sMeta.innerHTML = `Meta: ${layer.meta}${extra}${stump}${bullets ? "<br>"+bullets.replace(/\n/g,"<br>"):""}`;
    sheet.classList.add("open");
    sheet.setAttribute("aria-hidden","false");
  }

  function setGlobalMode(next){
    GLOBAL_MODE = next;
    const lens = MODE_NAMES[GLOBAL_MODE];
    const scope = FOREST_ON ? (PER_TREE ? "forest (per-tree lenses)" : "forest (global lens)") : "single organism";
    subtitle.innerHTML = `Global Mode: <strong>${lens}</strong> â€” ${scope}. Toggle <span class="kbd">F</span> Forest, <span class="kbd">G</span> Per-Tree.`;
    draw(Math.floor(Math.random()*1e6));
  }

  function toggleForest(){
    FOREST_ON = !FOREST_ON;
    document.getElementById("toggleForest").textContent = `ðŸŒ² Forest: ${FOREST_ON ? "On" : "Off"}`;
    setGlobalMode(GLOBAL_MODE);
  }

  function togglePerTree(){
    PER_TREE = !PER_TREE;
    document.getElementById("togglePerTree").textContent = `ðŸ§© Per-Tree Lenses: ${PER_TREE ? "On" : "Off"}`;
    setGlobalMode(GLOBAL_MODE);
  }

  // init
  window.addEventListener('DOMContentLoaded', ()=>{
    draw(42);
    document.getElementById("randomize").onclick = () => draw(Math.floor(Math.random()*1e6));
    document.getElementById("mode").onclick = () => setGlobalMode((GLOBAL_MODE + 1) % LENSES.length);
    document.getElementById("toggleForest").onclick = toggleForest;
    document.getElementById("togglePerTree").onclick = togglePerTree;
    window.addEventListener("keydown", (e)=>{
      if(e.key.toLowerCase()==='r') draw(Math.floor(Math.random()*1e6));
      if(e.key.toLowerCase()==='m') setGlobalMode((GLOBAL_MODE + 1) % LENSES.length);
      if(e.key.toLowerCase()==='f') toggleForest();
      if(e.key.toLowerCase()==='g') togglePerTree();
      if(e.key==='Escape') sheet.classList.remove('open');
    });
  });
})();
</script>
</body>
</html>
